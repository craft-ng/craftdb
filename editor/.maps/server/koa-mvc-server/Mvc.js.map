{"version":3,"sources":["server/koa-mvc-server/Mvc.ts"],"names":[],"mappings":"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","file":"server/koa-mvc-server/Mvc.js","sourcesContent":["import Koa = require(\"koa\");\nimport glob = require(\"glob\");\nimport path = require(\"path\");\nimport extend = require(\"extend\");\nconst KoaRouter = require('koa-router');\nconst views = require('koa-views');\n\nimport {KoaMiddleware} from \"./KoaMiddleware\";\nimport {MvcAreaDefinition} from \"./MvcAreaDefinition\";\n\ninterface RegisteredArea {\n    applicationRootPath: string;\n    areaPath: string;\n    options: MvcOptions;\n}\n\ninterface FoundController {\n    controller: MvcController;\n    area: RegisteredArea;\n}\n\nexport interface MvcController {\n    getRouter(): any;\n}\n\nexport interface MvcOptions {\n    controllers?: {\n        convention?: string;\n    };\n    views?: {\n        convention?: string;\n        extension?: string;\n        engine?: string;\n        middleware?: (area: RegisteredArea)=>KoaMiddleware;\n    };\n    middleware?: Array<(area: RegisteredArea)=>KoaMiddleware>;\n}\n\nexport class Mvc {\n\n    private registeredAreas: Array<RegisteredArea> = [];\n\n    public registerAreas(rootPath: string, areas: Array<string>, options: MvcOptions) {\n        options = extend(true, <MvcOptions>{\n            controllers: {convention: 'controllers/*.js'},\n            views: {\n                convention: 'views',\n                engine: 'ejs',\n                extension: 'html',\n                middleware: area => {\n\n                    var viewSearchDirectory = path.join(\n                        area.applicationRootPath,\n                        area.areaPath,\n                        area.options.views.convention\n                    );\n\n                    return views(viewSearchDirectory, {\n                        map: {[area.options.views.extension]: area.options.views.engine},\n                        extension: area.options.views.extension\n                    });\n                }\n            }\n        }, options);\n\n        for (var areaPath of areas) {\n            this.registeredAreas.push(<RegisteredArea>{\n                applicationRootPath: rootPath,\n                areaPath: areaPath,\n                options: options\n            });\n        }\n    }\n\n    private discoverControllers(): Array<FoundController> {\n        var controllers: Array<FoundController> = [];\n        for (var area of this.registeredAreas) {\n            var controllerSearchPattern: string = path.join(\n                area.applicationRootPath,\n                area.areaPath,\n                area.options.controllers.convention\n            );\n\n            var files: Array<string> = glob.sync(controllerSearchPattern);\n\n            for (var file of files) {\n                const ControllerClass = require(file);\n                controllers.push({\n                    controller: new ControllerClass(),\n                    area: area\n                });\n            }\n        }\n\n        return controllers;\n    }\n\n    private createArea(definition: MvcAreaDefinition) {\n\n        definition.parentRouter.use(\n            definition.rootRoute,\n            definition.viewMiddleware,\n            definition.routes\n        );\n    }\n\n    public routes(): KoaMiddleware {\n        const router = new KoaRouter();\n        for (var foundController of this.discoverControllers()) {\n\n            this.createArea({\n                rootRoute: foundController.area.areaPath,\n                parentRouter: router,\n                viewMiddleware: foundController.area.options.views.middleware(\n                    foundController.area\n                ),\n                routes: foundController.controller.getRouter().routes()\n            });\n        }\n\n        return router.routes();\n    }\n\n}"],"sourceRoot":"/source/"}